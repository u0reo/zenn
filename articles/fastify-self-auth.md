---
title: "fastifyã¨secure-sessionã§ç°¡å˜&é«˜é€Ÿãªã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«èªè¨¼"
emoji: "ğŸ—"
type: "tech"
topics: ["typescript", "nodejs", "fastify"]
published: true
---

ä»Šå›ã®ä¾‹ã§ã¯Apollo Serverã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚GraphQLã‚’ä½¿ã£ã¦ã„ãªã„å ´åˆãªã©ã§ã¯ã€Hooksã§createContextã®å†…å®¹ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

https://fastify.dev/docs/latest/Reference/Hooks/

# å…ˆã«å®Ÿè£…æ–¹æ³•

```ts:server.ts
import { ApolloServer } from '@apollo/server';
import Fastify from 'fastify';
import csrfProtection from '@fastify/csrf-protection';
import secureSession from '@fastify/secure-session';
import fastifyApollo from '@as-integrations/fastify';

import createContext, { Context } from './context';
import getBuilder from './builder';
import { GraphQLCustomErrorCode } from './utils/CustomGraphQLError';

const nowDevelopment = NODE_ENV === 'development';

export const makeFastifyServer = async () => {
  const app = Fastify();

  const apollo = new ApolloServer<Context>({
    schema: getBuilder().toSchema(),
  });

  await app.register(secureSession, {
    secret: SESSION_SECRET,
    salt: SESSION_SALT,
    cookie: {
      domain: undefined, // ã»ã‹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚¯ãƒƒã‚­ãƒ¼ã‚’å…±ç”¨ã—ãªã„ãŸã‚æœªå®šç¾©
      path: '/graphql', // graphqlã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿ã§ä½¿ç”¨
      httpOnly: true, // JavaScriptã§æ“ä½œã§ããªã„ã‚ˆã†ã«
      secure: !nowDevelopment, // HTTPSé€šä¿¡ã§ã®ã¿ã‚¯ãƒƒã‚­ãƒ¼ã‚’é€ä¿¡
      expires: undefined, // æœ‰åŠ¹æœŸé™æ—¥æ™‚ã¯è¨­ã‘ãªã„(ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã¨ã)
      maxAge: SESSION_MAX_AGE, // æœ‰åŠ¹æ™‚é–“(ç§’)
      sameSite: nowDevelopment ? 'strict' : 'none', // ä»–ãƒ‰ãƒ¡ã‚¤ãƒ³é–“ã§ã®é·ç§»æ™‚ã«é–¢ä¿‚ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è·¨ããŸã‚ä¸€ç•ªå¼±ã„ã‚‚ã®ã«
      // options for setCookie, see https://github.com/fastify/fastify-cookie
    },
  });
  await app.register(csrfProtection, { sessionPlugin: '@fastify/secure-session' });

  await app.register(fastifyApollo(apollo), {
    context: createContext,
  });

  return app;
};
```

```ts:createContext.ts
import { ApolloFastifyContextFunction } from '@as-integrations/fastify';
import { prisma } from './prisma';
import { repositories } from './repository';

export interface Context {
  repos: ReturnType<typeof repositories>;
  userId: string;
}


const createContext: ApolloFastifyContextFunction<Context> = async (request) => {
  const repos = repositories(prisma);

  let userId: string | undefined | null = request.session.userId;

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
  if (userId) {
    const user = await repos.user.getUserById(userId);
    if (!user) {
      userId = null;
    }
  }

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç©ºã ã£ãŸã‚Šã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå¤ã‘ã‚Œã°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†ä½œæˆ(ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å†ä½œæˆ)
  if (
    !userId ||
    !request.session.lastRefreshedAt ||
    request.session.lastRefreshedAt < Date.now() - SESSION_MAX_AGE * 1000
  ) {
    const newUser = await repos.user.createUser();
    userId = newUser.id;
    request.session.set('userId', userId);
  }

  // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’æ›´æ–°(ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è€ƒæ…®ä¸è¦)
  request.session.set('lastRefreshedAt', Date.now());

  return {
    repos,
    userId,
  };
};

export default createContext;
```

```ts:SessionData.d.ts
import '@fastify/secure-session';

declare module '@fastify/secure-session' {
  interface SessionData {
    userId: string;
    lastRefreshedAt: number;
  }
}
```

## æº€ãŸã›ã‚‹è¦ä»¶

* å¤–éƒ¨APIãŒãªãé«˜é€Ÿ
* ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã™ã¹ã¦ç®¡ç†
  * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ã‘ã‚Œã°ã€ä¿å­˜ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã«åˆ¶é™ãªã—
  * å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨äºŒé‡ç®¡ç†ã«ãªã‚‰ãªã„
* ãƒ•ãƒ­ãƒ³ãƒˆã¯éåŒæœŸé€šä¿¡æ™‚ã«ã‚¯ãƒƒã‚­ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã ã‘

## æº€ãŸã›ãªã„è¦ä»¶

* DBãªã—ã®é‹ç”¨(ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã§ããªã„)
* å¤šãã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®OIDCã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³ã‚’ç°¡å˜ã«è¨­å®šã—ãŸã„å ´åˆ(ã‚·ãƒ³ãƒ—ãƒ«ã«å¤§å¤‰)

-----

# è¬è¾

ä»Šå›ã¯ã‚µã‚¤ãƒãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®[æ¬¡ä¸–ä»£ãƒˆãƒƒãƒ—ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‰µå‡ºã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã‚·ãƒƒãƒ—ACE](https://www.cyberagent.co.jp/careers/students/event/detail/id=28690)ã«å‚åŠ ã„ãŸã—ã¾ã—ãŸã€‚ãã“ã§å¾—ãŸçŸ¥è¦‹ã¨ãªã‚Šã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å…±ã«ã—ãŸ[ãšãƒ¼ã¾ã•ã‚“](https://twitter.com/azuma_alvin)ã‚„ãƒ¡ãƒ³ã‚¿ãƒ¼ã®çš†æ§˜ã‚’ã¯ã˜ã‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

# æ¦‚è¦

Expressã‚ˆã‚Šé€Ÿã„ã¨ã„ã‚ã‚Œã¦ã„ã‚‹fastifyã‚’æ¡ç”¨ã™ã‚‹ã‚±ãƒ¼ã‚¹ã¯å¢—ãˆã¦ã„ã¾ã™ãŒã€ãƒ•ãƒ­ãƒ³ãƒˆ&ã‚µãƒ¼ãƒãƒ¼é–“ã®èªè¨¼ã«å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«é ¼ã£ã¦ã—ã¾ã†ã®ã¯**æ€ æ…¢**ã§ã™ã—ã€ãªã«ã‚ˆã‚Š**ãã®åˆ†é…ããªã£ã¦**ã„ã¾ã™ã‚ˆã­ï¼Ÿï¼Ÿ

ãã“ã§ã€ä»Šå›ã¯é©åˆ‡ãªã‚¯ãƒƒã‚­ãƒ¼ã®è¨­å®šã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ã™ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã‚‹è‡ªå‰èªè¨¼ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

ãªãŠã€å¾Œè¿°ã—ã¾ã™ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³(ã‚¯ãƒƒã‚­ãƒ¼)ã¯100%ä¸­èº«ã‚’è¦‹ã‚‰ã‚Œãªã„ä¿è¨¼ã¯ãªã„ãŸã‚ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã®å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã®å®Ÿè£…ã¯ä»¥ä¸‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

https://zenn.dev/calloc134/articles/fcff7a2ec2753c

# firebase Auth ã®æµã‚Œ

ã¾ãšã¯æ¯”è¼ƒå¯¾è±¡ã¨ã—ã¦ã€ã‚ˆãä½¿ã‚ã‚Œã‚‹èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹firebase Authã§è€ƒãˆã¾ã™ã€‚

https://firebase.google.com/docs/auth/web/anonymous-auth?hl=ja

## ãƒ•ãƒ­ãƒ³ãƒˆå´

1. onAuthStateChanged()ã§ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ³ã‚’ç¢ºèª
   a. â˜…å†…éƒ¨ã§ã¯firebaseã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›ã¦ã€æ¤œè¨¼ã—ã¦ã„ã‚‹
2. ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ã°ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªAPIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸
3. â˜…Firebaseã®IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®šæœŸçš„ã«æ›´æ–°ã™ã‚‹ã“ã¨ã§ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¶­æŒ

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ (ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªAPI)

1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
   a. â˜…å†…éƒ¨ã§ã¯firebaseã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›ã¦ã€æ¤œè¨¼ã—ã¦ã„ã‚‹
2. æ¤œè¨¼ãŒæˆåŠŸã™ã‚Œã°ã€`auth.token.sub`ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ã—ã¦åˆ©ç”¨

https://firebase.google.com/docs/auth/admin/verify-id-tokens?hl=ja#web

ãªãŠã€`sub`ã¯`uid`ã¨åŒã˜ãªæ¨¡æ§˜

https://stackoverflow.com/questions/40920403/what-is-the-difference-between-auth-uid-and-auth-token-sub-in-firebase-realtime

# è‡ªå‰èªè¨¼ã®æµã‚Œ

## ãƒ•ãƒ­ãƒ³ãƒˆå´ (ç¢ºèª)

ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚¯ãƒƒã‚­ãƒ¼ã¨å¤‰ã‚ã‚Šã‚ã‚Šã¾ã›ã‚“ã€‚

1. ãƒ­ã‚°ã‚¤ãƒ³ã«ã¾ã¤ã‚ã‚‹ã‚¯ãƒƒã‚­ãƒ¼ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ â†’ ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³
2. â˜…ã‚µãƒ¼ãƒãƒ¼ã«ä¿æŒã—ã¦ã„ã‚‹ã‚¯ãƒƒã‚­ãƒ¼ã‚’é€ä¿¡ã—ã€æ¤œè¨¼ã‚’ä¾é ¼ â†’ ç„¡åŠ¹ã ã£ãŸã‚ŠæœŸé™åˆ‡ã‚Œã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³
3. ã‚¯ãƒƒã‚­ãƒ¼ã®å¦¥å½“æ€§ãŒç¢ºèªã§ãã‚Œã°ã€ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã¨åˆ¤å®š

2ç•ªã¯whoamiç­‰ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªAPIã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã¯ã‚¯ãƒƒã‚­ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã ã‘ã§OKã€‚(ã‚µãƒ¼ãƒãƒ¼ã«ä»»ã›ã¦ã‚‚å¯)

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´

### ãƒ­ã‚°ã‚¤ãƒ³API

1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚‚ã¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç…§åˆã€‚ â†’ ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
2. **\[ã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®š\]**
3. ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã®è¿½åŠ ã‚„ãƒ­ã‚°ã‚¤ãƒ³ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ãªã©â€¦
4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´

### ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªAPI

1. **\[ã‚¯ãƒƒã‚­ãƒ¼ã‚’èª­å–&æ¤œè¨¼\]**
2. **\[ã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®š\]**
3. (å„å‡¦ç†)
4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯å†åº¦ç”Ÿæˆã—ãŸSet-Cookieã‚’å«ã‚ã‚‹ã“ã¨ã§ã€ã‚¯ãƒƒã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ã‚’å»¶é•·ã—ã¦ã„ã¾ã™ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ãŒä¸è¦ãªAPIã§ã‚‚ã€ã‚¯ãƒƒã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ã‚’å»¶ã°ã™ãªã‚‰ã°åŒã˜å‹•ä½œãŒå¿…è¦ã§ã™ã€‚

# æ¯”è¼ƒçµæœ

firebase Auth ã‚’ä½¿ã†ã¨èªè¨¼ã«ã¾ã¤ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ

- APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ãŸã‚Šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§1ã¤
- å®šæœŸçš„ãªãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒ•ãƒ­ãƒ³ãƒˆå´ã§1ã¤

ã¨å¢—ãˆã¦ã—ã¾ã†ä¸Šã€ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‚„APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯ã«ã‚‚firebaseã‚’å¾…ã¤ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§å®Ÿç¾ã™ã‚‹ã¨ã€ã“ã‚Œã‚‰ã‚’å‰Šæ¸›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã—ã‹ã—ã€èªè¨¼ã«å¯¾ã™ã‚‹å®‰å…¨æ€§ã‚’è‡ªåˆ†ã§ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€**ä»•çµ„ã¿ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç†è§£ã—ã¦ãŠãã“ã¨ãŒå¤§äº‹**ã«ãªã‚Šã¾ã™ã€‚

# ä»•çµ„ã¿

## ã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®š

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨æœ€çµ‚æ›´æ–°æ—¥æ™‚(ç¾åœ¨æ—¥æ™‚)ã‚’`request.session`ã«è¨­å®šã€‚ â† `createContext()`
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœ§ç¸®&æš—å·åŒ–ã—ã€ã‚¯ãƒƒã‚­ãƒ¼æ–‡å­—åˆ—ã¨ã—ã¦ç”Ÿæˆã€‚ â† @fastify/secure-session
3. HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã§Set-Cookieã¨å…±ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ã‚‹ã€‚ â† fastify

ãƒ–ãƒ©ã‚¦ã‚¶ã¯Set-Cookieã«å¾“ã£ã¦ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä¿æŒã€‚

## ã‚¯ãƒƒã‚­ãƒ¼ã‚’èª­å–&æ¤œè¨¼

ã‚¯ãƒƒã‚­ãƒ¼ã®å±æ€§è¨­å®šãŒæ­£ã—ã‘ã‚Œã°ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã‚¯ãƒƒã‚­ãƒ¼ã‚’å«ã‚ã¾ã™ã€‚

1. ã‚¯ãƒƒã‚­ãƒ¼ã®å¾©å·åŒ–ã‚’è©¦ã¿ã‚‹ã€‚
2. å¾©å·ã—ãŸã‚¯ãƒƒã‚­ãƒ¼ã‚’JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹ã€‚ â† ã“ã“ã¾ã§ @fastify/secure-session
3. æœ€çµ‚æ›´æ–°æ—¥æ™‚ãŒæ±ºã‚ãŸæ™‚é–“ã‚ˆã‚Šå¤ããªã„ã“ã¨ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã€‚ â† `createContext()`

â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãŒæˆåŠŸã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨åŒä¸€ã¨ã¿ãªã—ã¦å‡¦ç†ã‚’é€²ã‚ã‚‹ã€‚

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

## ã‚¯ãƒƒã‚­ãƒ¼ã®è¨­å®š

`server.ts`ã®cookieå†…ã§è¨­å®šã—ã¾ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã®æ—¥æœ¬èªè¨³ã«è¿‘ã„ã§ã™ã€‚

https://github.com/fastify/fastify-cookie#parseoptions

ãªãŠã€ã‚¯ãƒƒã‚­ãƒ¼ã®è¨­å®šã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ãŠé¡˜ã„ã™ã‚‹å†…å®¹ãªã®ã§ã€**ã©ã‚Œã ã‘æº–æ‹ ã—ã¦ãã‚Œã‚‹ã‹ã¯ãƒ–ãƒ©ã‚¦ã‚¶æ¬¡ç¬¬**ã§ã™ã€‚curlç­‰ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„DevToolsã§è¦‹ã‚‰ã‚ŒãŸSet-Cookieã®å€¤ã‚’ä¿æŒã™ã‚Œã°ã„ãã‚‰ã§ã‚‚ç ´ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã‚¯ãƒƒã‚­ãƒ¼ã«ã™ã‚‹ã“ã¨ã§çŠ¶æ…‹ç®¡ç†ãŒç™ºç”Ÿã™ã‚‹ã‚‚ã®ã®ã€åœ§å€’çš„ã«ã‚»ã‚­ãƒ¥ã‚¢ã«ãªã‚Šã¾ã™ã€‚

### domain

ä»–ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§å…±ç”¨ã—ãªã„ãŸã‚ã€ã‚ãˆã¦undefinedã‚’æŒ‡å®šã—ã¾ã™ã€‚(è¨˜è¿°ã—ãªãã¦ã‚‚å¯)

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ›¸ã„ã¦ã—ã¾ã†ã¨ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚‚ã‚¯ãƒƒã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã—ã¾ã†ã¨ã‹ï¼Ÿ

https://blog.tokumaru.org/2011/10/cookiedomain.html

### path

ã‚ã¾ã‚Šæ„å‘³ãªã„ã‚‰ã—ã„ã§ã™ãŒã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ã†è¦ªãƒ‘ã‚¹ãŒæ±ºã¾ã£ã¦ã„ãŸã‚Šã€GrpahQLã®å ´åˆã¯è¨­å®šã™ã‚‹ã¨ã‚ˆã„ã‹ã‚‚ã€‚

æŒ‡å®šã—ãªã„å ´åˆã¯å¸¸ã«é€ä¿¡ã•ã‚Œã‚‹ã®ã§ã€å…ˆã»ã©ã®å®Ÿè£…ã¯å‹æ‰‹ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

### httponly

JavaScriptã§æ“ä½œã§ããªã„ã‚ˆã†ã€trueã‚’è¨­å®šã—ã¾ã™ã€‚

### secure

HTTPSã®ã¿ã§ã‚¯ãƒƒã‚­ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã‹ã©ã†ã‹ã€‚é–‹ç™ºæ™‚ä»¥å¤–ã¯ã‹ãªã‚‰ãštrueã«è¨­å®šã—ã¾ã™ã€‚

(å¸¸ã«trueã§ã‚‚localhostã¯è¨±ã•ã‚Œã‚‹ã¨ã‹è¨±ã•ã‚Œãªã„ã¨ã‹â€¦ï¼Ÿ)

### expires

ã‚¯ãƒƒã‚­ãƒ¼(ã‚»ãƒƒã‚·ãƒ§ãƒ³)ã®å¤±åŠ¹æ—¥æ™‚ã‚’æ–‡å­—åˆ—ã§æŒ‡å®šã—ã¾ã™ã€‚å¾Œè¿°ã®maxAgeã§è¨­å®šã™ã‚Œã°ã‚ˆã„ã®ã§ã€undefinedã¨ã™ã‚‹ã“ã¨ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã¨ãã«å¤±åŠ¹ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚é ã‚ã®æ—¥æ™‚ã‚’è¨­å®šã—ã€ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†æ™‚ã®å¤±åŠ¹ã‚’é˜²ãã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

### maxAge

ã‚¯ãƒƒã‚­ãƒ¼(ã‚»ãƒƒã‚·ãƒ§ãƒ³)ã®æœ‰åŠ¹æ™‚é–“ã‚’ç§’å˜ä½ã§æŒ‡å®šã—ã¾ã™ã€‚ä»»æ„ã®æ™‚é–“ã§è¨­å®šã—ã¾ã™ã€‚

### sameSite

é•ã†ãƒ‰ãƒ¡ã‚¤ãƒ³é–“ã§ã®é·ç§»æ™‚ã«ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹ã‹ã®è¨­å®šã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è·¨ãä¸Šã€APIã‚µãƒ¼ãƒãƒ¼ã§ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä½¿ã†å ´åˆã¯noneãŒå¿…é ˆã€‚ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯é–‹ç™ºæ™‚ã¯strictã«ã€‚

https://qiita.com/KWS_0901/items/695bd1ecc17a8c2e6d69

## ã‚¯ãƒƒã‚­ãƒ¼(ã‚»ãƒƒã‚·ãƒ§ãƒ³)ã®æš—å·åŒ–

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å½è£…ã•ã‚Œãªã„ãŸã‚ã«æš—å·åŒ–ã¯å¿…é ˆã§ã™ã€‚@fastify/secure-sessionã§ã¯ã€ã„ãã¤ã‹ã®æ–¹æ³•ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

* ç§˜å¯†éµæ–¹å¼(`key`ã€`secret`ã¨`salt`)
* ç§˜å¯†éµã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹æ–¹å¼(`key: [mySecureKey]`)

`secret`ã¨`salt`ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨å¼·åŠ›ãªç§˜å¯†éµã‚’èµ·å‹•æ™‚ã«ç”Ÿæˆã™ã‚‹ãŸã‚ã€ä¸€ç•ªç°¡ä¾¿ã§å¼·å›ºã§ã™ã€‚ä»Šå›ã¯ã“ã®æ–¹å¼ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

é©å®œã€ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹æ–¹ãŒã‚‚ã£ã¨å¼·å›ºã«ãªã‚Šã¾ã™ãŒã€ä»Šå›ã¯å–ã‚Šä¸Šã’ã¾ã›ã‚“ã€‚è©³ã—ã„ã“ã¨ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãœã²è¦‹ã¦ãã ã•ã„ã€‚

https://github.com/fastify/fastify-secure-session/#using-keys-with-key-rotation

## CSRFã®è¨­å®š

https://github.com/fastify/csrf-protection#use-with-fastifysecure-session

```ts
await app.register(csrfProtection, { sessionPlugin: '@fastify/secure-session' });
```

## ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã«æœ€æ–°æ›´æ–°æ—¥æ™‚ã®è¿½åŠ 

ã‚¯ãƒƒã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦åˆ¶å¾¡ã•ã‚Œã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼å´ã§åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã«åŸ‹ã‚è¾¼ã‚€ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ä¿æŒã—ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç”Ÿæˆæ™‚ã«ç¾åœ¨æ—¥æ™‚ã‚’åŸ‹ã‚è¾¼ã¿ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿å–ã‚Šæ™‚ã«æ±ºã‚ã‚‰ã‚ŒãŸæ—¥æ™‚ã‚ˆã‚Šå¤ããªã„ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

```ts
request.session.set('lastRefreshedAt', Date.now());
```

```ts
if (
  !request.session.lastRefreshedAt ||
  request.session.lastRefreshedAt < Date.now() - SESSION_MAX_AGE * 1000
) {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ
}
```

# æ³¨æ„ç‚¹1: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«JSONã§æ‰±ãˆãªã„å‹ã¯å«ã‚ãªã„

`request.session`ã«è¨­å®šã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ãªã‚“ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã¯å‡ºã¾ã›ã‚“ãŒã€`JSON.stringify()`ã‚„`JSON.parse()`ã‚’è¡Œã„ã¾ã™ã€‚

https://github.com/fastify/fastify-secure-session/blob/28b8f161513baa5a1e3aedb7ac6a57c18efd5e74/index.js#L202

https://github.com/fastify/fastify-secure-session/blob/28b8f161513baa5a1e3aedb7ac6a57c18efd5e74/index.js#L187

ãã®ãŸã‚ã€JSONã§æ‰±ãˆã‚‹å‹ã«ã—ã¦ãŠãã®ãŒã¹ãã§ã—ã‚‡ã†ã€‚ä¾‹ãˆã°ã€Dateã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ãŒèµ·ã“ã£ãŸã‚Šã€`JSON.parse()`ã§ã¯æ–‡å­—åˆ—ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã€`SessionData.d.ts`ã®å‹ã¨ä¸æ•´åˆãŒç”Ÿã˜ã¦ã—ã¾ã„ã¾ã™ã€‚

https://qiita.com/querykuma/items/c0c1775e9e8d74b1a378

ã¤ã¾ã‚Šã€ä½¿ãˆã‚‹å‹ã¯

* æ–‡å­—åˆ—
* æ•°å€¤
* null
* çœŸå½å€¤(true, false)
* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ(ä¾‹: { a: 1, b: 2, â€¦ })
* é…åˆ—(ä¾‹: \[ 1, 2, â€¦ \])

ã«ãªã‚Šã¾ã™ã€‚ã“ã®ãŸã‚ã€ä»Šå›ã®å®Ÿè£…ã§ã¯æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’UNIXæ™‚é–“ã§ä¿å­˜ã—ã¾ã—ãŸã€‚

https://www.tohoho-web.com/ex/json.html

# æ³¨æ„ç‚¹2: 2ç¨®é¡ã®æœ‰åŠ¹æœŸé™

ä»Šå›ã®å®Ÿè£…ã§ã¯ã‚¯ãƒƒã‚­ãƒ¼ã®maxAgeã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®æœ€çµ‚æ›´æ–°æ—¥æ™‚ã«ã‚ˆã‚‹2ã¤ã®æœ‰åŠ¹æœŸé™ãŒç™»å ´ã—ã¾ã™ã€‚

| ç¨®é¡ | ã‚¯ãƒƒã‚­ãƒ¼ | æœ€çµ‚æ›´æ–°æ—¥æ™‚ |
|----|----|----|
| åå‰ | maxAge | lastRefreshedAt |
| è¨­å®šå ´æ‰€ | ãƒ–ãƒ©ã‚¦ã‚¶(ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰) | ã‚µãƒ¼ãƒãƒ¼ |
| è¨­å®šã‚¿ã‚¤ãƒŸãƒ³ã‚° | ã‚¯ãƒƒã‚­ãƒ¼ç”Ÿæˆæ™‚ | ã‚¯ãƒƒã‚­ãƒ¼ã®æ¤œè¨¼æ™‚ |
| ç¢ºå®Ÿã«é©ç”¨ã•ã‚Œã‚‹ã‹ | **ç¢ºå®Ÿã§ã¯ãªã„** | ç¢ºå®Ÿ |

APIã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã‚‹å´ã¨ã—ã¦ã¯ä¸Šã®ã‚ˆã†ã«æ¯”è¼ƒã•ã‚Œã¾ã™ã€‚å¤§äº‹ãªã®ã¯ã€ã‚¯ãƒƒã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ã¯ç¢ºå®Ÿã«é©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œãªã„ã®ã§ã€æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’åˆ¥é€”è¨­å®šã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’ä¿è¨¼ã§ãã¾ã™ã€‚

# è¤‡æ•°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ§‹æˆã™ã‚‹ã«ã¯

ä»¥ä¸‹ã®ã‚ˆã†ãªã€`sessionName`ã‚’ã»ã‹ã®è¨­å®šã¨å¤‰ãˆãŸã‚‚ã®ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ã§å¯èƒ½ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`session`ã€‚ã¾ãŸã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã¯`request.[sessionName]`ã®ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ä¾‹ã§ã¯`request.example`ã§ã™ã€‚

server.ts

```ts
  await app.register(secureSession, {
    sessionName: 'example', // ã“ã“ã‚’è¢«ã‚‰ãªã„ã‚ˆã†ã«ã—ã¦è¿½åŠ 
    secret: SESSION_SECRET,
    salt: SESSION_SALT,
    cookie: {
      // options for setCookie, see https://github.com/fastify/fastify-cookie
    },
  });
```

https://github.com/fastify/fastify-secure-session/#multiple-sessions

# @fastify/secure-sessionã§è¿½åŠ ã—ãŸå®Ÿè£…ã®å‹å®šç¾©ã‚’è¿½åŠ 

ä»Šå›ã®å®Ÿè£…ã§ã¯`SessionData.d.ts`ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚Œã°ã€`request.session`ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚è¤‡æ•°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹å ´åˆã¯`FastifyRequest`ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã™ã‚‹å ´åˆã¯ã€

```ts
import '@fastify/secure-session';

declare module '@fastify/secure-session' {
  interface SessionData {
    foo: string;
    bar: number;
  }
}
```

ã‚„

```ts
import 'fastify';
import { Session } from '@fastify/secure-session';

interface ExampleSessionData {
  foo: string;
  bar: number;
}

declare module 'fastify' {
  interface FastifyRequest {
    example: Session<ExampleSessionData>;
  }
}
```

ã®ã‚ˆã†ã«importãŒå¿…è¦ã§ã™ã€‚(è¦æ¤œè¨¼ï¼Ÿ)

https://github.com/fastify/fastify-secure-session/#add-typescript-types

# ã¾ã¨ã‚

èªè¨¼ã®ãƒ•ãƒ­ãƒ¼ã‚’ã‚ˆãç†è§£ã—ã¦ã„ã‚Œã°ã€è‡ªå‰ã§ã®å®Ÿè£…ã§ã‚‚ç°¡å˜ã«ä½œã‚Œã¦ã€ã‹ã¤ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’æŠ‘ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚firebase Authç­‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ã¦ã‚‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ›´æ–°ã¯æ¬ ã‹ã›ãªã„ã§ã™ã—ã€è¦ä»¶ã«å¿œã˜ã¦æ­£ã—ãé¸ã‚“ã§ä½¿ã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
